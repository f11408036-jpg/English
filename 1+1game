<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è–èª•ç¦®ç‰©å¤§ä½œæˆ° - è´å–å°ˆå±¬æŠ˜æ‰£ç¢¼ï¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');

        body {
            font-family: 'Fredoka', sans-serif;
            overflow: hidden;
            touch-action: none; /* Prevent scroll on mobile */
            background: linear-gradient(to bottom, #1a2a6c, #b21f1f, #fdbb2d); /* Christmas Night Gradient */
        }

        #game-canvas {
            display: block;
            width: 100%;
            height: 100vh;
        }

        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .interactive {
            pointer-events: auto;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 4px solid #c0392b;
            text-align: center;
            max-width: 90%;
            width: 400px;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .btn-primary {
            background: #27ae60;
            color: white;
            font-weight: bold;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1.2rem;
            border: none;
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
            box-shadow: 0 4px 0 #219150;
            text-transform: uppercase;
            margin-top: 1rem;
        }

        .btn-primary:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #219150;
        }

        .btn-secondary {
            background: #e74c3c;
            box-shadow: 0 4px 0 #c0392b;
        }
        .btn-secondary:active {
            box-shadow: 0 0 0 #c0392b;
        }

        .score-hud {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 1.5rem;
            font-weight: bold;
            z-index: 5;
            display: none;
        }
        
        .lives-hud {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.5rem;
            z-index: 5;
            display: none;
        }

        .coupon-card {
            background: #f1c40f;
            color: #d35400;
            padding: 15px;
            border-radius: 10px;
            border: 2px dashed #d35400;
            margin: 15px 0;
            font-weight: bold;
            position: relative;
        }

        .hidden { display: none !important; }
        
        /* Snow animation container */
        #snow-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
    </style>
</head>
<body>

    <!-- UI: Start Screen -->
    <div id="start-screen" class="ui-layer interactive">
        <div class="glass-panel">
            <h1 class="text-4xl font-bold text-red-600 mb-2">ğŸ„ è–èª•ç¦®ç‰©å¤§ä½œæˆ°</h1>
            <p class="text-gray-600 mb-6">æ¥ä½è–èª•è€äººçš„ç¦®ç‰©ï¼Œé¿é–‹ç…¤ç‚­ï¼<br>åˆ†æ•¸è¶Šé«˜ï¼ŒæŠ˜æ‰£è¶Šå¤§ï¼</p>
            
            <div class="bg-red-50 p-4 rounded-xl mb-6 text-left text-sm text-gray-700">
                <p class="font-bold mb-2">ğŸ çå‹µè¦å‰‡ï¼š</p>
                <ul class="list-disc pl-5 space-y-1">
                    <li>100åˆ†ä»¥ä¸Šï¼š<span class="text-green-600 font-bold">$50 æŠ˜æ‰£</span></li>
                    <li>300åˆ†ä»¥ä¸Šï¼š<span class="text-blue-600 font-bold">$150 æŠ˜æ‰£</span></li>
                    <li>500åˆ†ä»¥ä¸Šï¼š<span class="text-purple-600 font-bold">$300 æŠ˜æ‰£</span></li>
                    <li>800åˆ†ä»¥ä¸Šï¼š<span class="text-red-600 font-bold">VIP 5æŠ˜å„ªæƒ </span></li>
                </ul>
            </div>

            <button id="start-btn" class="btn-primary w-full">é–‹å§‹æŒ‘æˆ°</button>
        </div>
    </div>

    <!-- UI: Game Over / Reward Screen -->
    <div id="game-over-screen" class="ui-layer interactive hidden">
        <div class="glass-panel">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">éŠæˆ²çµæŸ!</h2>
            <div class="text-5xl font-bold text-red-600 mb-4" id="final-score">0</div>
            <p class="text-gray-600 mb-4">æ­å–œæ‚¨ç²å¾—ï¼š</p>
            
            <!-- Dynamic Coupon Area -->
            <div id="reward-area" class="coupon-card">
                <div class="text-sm uppercase tracking-wide">æ‚¨çš„å°ˆå±¬æŠ˜æ‰£ç¢¼</div>
                <div id="coupon-code" class="text-2xl font-black my-1">XMAS2024</div>
                <div id="coupon-desc" class="text-sm">æ»¿åƒæŠ˜ç™¾</div>
            </div>

            <button id="copy-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm mb-6 hover:bg-gray-300 transition w-full">
                ğŸ“‹ è¤‡è£½æŠ˜æ‰£ç¢¼
            </button>

            <div class="flex gap-2 justify-center">
                <button id="restart-btn" class="btn-primary btn-secondary text-sm px-6">å†ç©ä¸€æ¬¡</button>
                <button onclick="window.location.href='#'" class="btn-primary text-sm px-6">å‰å¾€è³¼ç‰©</button>
            </div>
        </div>
    </div>

    <!-- HUD -->
    <div id="score-hud" class="score-hud">Score: 0</div>
    <div id="lives-hud" class="lives-hud">â¤ï¸â¤ï¸â¤ï¸</div>

    <!-- Game Canvas -->
    <canvas id="game-canvas"></canvas>

    <script>
        // Game Constants & Variables
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        let animationId;
        let score = 0;
        let lives = 3;
        let gameActive = false;
        let frameCount = 0;
        let spawnRate = 60; // Frames between spawns
        let gameSpeed = 3; 

        // Responsive Canvas
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Game Objects
        const player = {
            x: canvas.width / 2,
            y: canvas.height - 100,
            width: 80,
            height: 80,
            emoji: 'ğŸ›·' // Sleigh
        };

        let items = [];
        let particles = []; // For effects

        // Assets (Using Emojis for simplicity)
        const itemTypes = [
            { type: 'gift', emoji: 'ğŸ', score: 10, weight: 0.6 },
            { type: 'bear', emoji: 'ğŸ§¸', score: 20, weight: 0.2 },
            { type: 'candy', emoji: 'ğŸ¬', score: 5, weight: 0.1 },
            { type: 'coal', emoji: 'ğŸª¨', score: 0, damage: 1, weight: 0.1 } // Coal hurts
        ];

        // Reward Logic Config
        const rewards = [
            { min: 0, code: 'XMAS50', desc: 'ç¾æŠ˜ $50', color: '#27ae60' },
            { min: 100, code: 'XMAS150', desc: 'ç¾æŠ˜ $150', color: '#2980b9' },
            { min: 300, code: 'XMAS300', desc: 'ç¾æŠ˜ $300', color: '#8e44ad' },
            { min: 500, code: 'SUPER50OFF', desc: 'å…¨é¤¨ 5 æŠ˜ VIP åˆ¸', color: '#c0392b' }
        ];

        // --- Input Handling ---
        let targetX = canvas.width / 2;

        function updatePlayerPosition(clientX) {
            targetX = clientX;
        }

        // Touch
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            updatePlayerPosition(e.touches[0].clientX);
        }, { passive: false });

        canvas.addEventListener('touchstart', (e) => {
             updatePlayerPosition(e.touches[0].clientX);
        }, { passive: false });

        // Mouse
        canvas.addEventListener('mousemove', (e) => {
            updatePlayerPosition(e.clientX);
        });

        // --- Game Logic ---

        class Item {
            constructor() {
                this.r = Math.random();
                // Weighted random selection
                let sum = 0;
                let selected = itemTypes[0];
                for(let type of itemTypes) {
                    sum += type.weight;
                    if(this.r <= sum) {
                        selected = type;
                        break;
                    }
                }

                this.type = selected.type;
                this.emoji = selected.emoji;
                this.scoreVal = selected.score;
                this.damage = selected.damage || 0;
                
                this.x = Math.random() * (canvas.width - 40) + 20;
                this.y = -50;
                this.size = 40 + Math.random() * 10;
                this.speed = (gameSpeed + Math.random() * 2) * (canvas.height / 800); // Scale speed by height
                this.rotation = Math.random() * Math.PI;
                this.rotSpeed = (Math.random() - 0.5) * 0.1;
            }

            update() {
                this.y += this.speed;
                this.rotation += this.rotSpeed;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                ctx.font = `${this.size}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(this.emoji, 0, 0);
                ctx.restore();
            }
        }

        class Particle {
            constructor(x, y, text, color) {
                this.x = x;
                this.y = y;
                this.text = text;
                this.color = color;
                this.life = 1.0;
                this.vy = -2;
            }
            update() {
                this.y += this.vy;
                this.life -= 0.02;
            }
            draw() {
                ctx.globalAlpha = Math.max(0, this.life);
                ctx.fillStyle = this.color;
                ctx.font = "bold 20px Arial";
                ctx.fillText(this.text, this.x, this.y);
                ctx.globalAlpha = 1.0;
            }
        }

        // Snow background
        const snowflakes = Array(50).fill().map(() => ({
            x: Math.random() * window.innerWidth,
            y: Math.random() * window.innerHeight,
            r: Math.random() * 3 + 1,
            d: Math.random() * 50
        }));

        function drawBackground() {
            // Draw Snow
            ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
            snowflakes.forEach(f => {
                ctx.beginPath();
                ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
                ctx.fill();
                f.y += Math.pow(f.d, 0.5) * 0.5; // fall speed
                f.x += Math.sin(f.y * 0.01) * 0.5; // sway
                
                if (f.y > canvas.height) {
                    f.y = -10;
                    f.x = Math.random() * canvas.width;
                }
            });
        }

        function startGame() {
            score = 0;
            lives = 3;
            gameSpeed = 3;
            spawnRate = 60;
            items = [];
            particles = [];
            gameActive = true;
            
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-over-screen').classList.add('hidden');
            document.getElementById('score-hud').style.display = 'block';
            document.getElementById('score-hud').textContent = `Score: ${score}`;
            document.getElementById('lives-hud').style.display = 'block';
            updateLivesDisplay();

            gameLoop();
        }

        function updateLivesDisplay() {
            let hearts = '';
            for(let i=0; i<lives; i++) hearts += 'â¤ï¸';
            for(let i=lives; i<3; i++) hearts += 'ğŸ–¤';
            document.getElementById('lives-hud').textContent = hearts;
        }

        function gameOver() {
            gameActive = false;
            cancelAnimationFrame(animationId);
            
            // Determine Reward
            let reward = rewards[0];
            for (let i = rewards.length - 1; i >= 0; i--) {
                if (score >= rewards[i].min) {
                    reward = rewards[i];
                    break;
                }
            }

            // Update UI
            document.getElementById('final-score').innerText = score;
            document.getElementById('coupon-code').innerText = reward.code;
            document.getElementById('coupon-code').style.color = reward.color;
            document.getElementById('coupon-desc').innerText = reward.desc;
            document.getElementById('game-over-screen').classList.remove('hidden');
            document.getElementById('score-hud').style.display = 'none';
            document.getElementById('lives-hud').style.display = 'none';
        }

        function gameLoop() {
            if (!gameActive) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            drawBackground();

            // Smooth Player Movement
            // Linear interpolation (Lerp) for smoothness
            player.x += (targetX - player.x) * 0.2;
            
            // Draw Player
            ctx.font = `${player.width}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            ctx.fillText(player.emoji, player.x, player.y + 10);

            // Spawner Logic
            frameCount++;
            if (frameCount % spawnRate === 0) {
                items.push(new Item());
                // Increase difficulty
                if(frameCount % 300 === 0) {
                    gameSpeed += 0.5;
                    if(spawnRate > 20) spawnRate -= 5;
                }
            }

            // Update Items
            for (let i = items.length - 1; i >= 0; i--) {
                let item = items[i];
                item.update();
                item.draw();

                // Collision Detection
                // Simple box/circle distance check
                let dx = item.x - player.x;
                let dy = item.y - (player.y - player.height/2);
                let distance = Math.sqrt(dx*dx + dy*dy);

                if (distance < player.width/2 + item.size/2) {
                    // Hit!
                    if (item.damage > 0) {
                        lives -= item.damage;
                        particles.push(new Particle(player.x, player.y - 50, "-1 Life", "#c0392b"));
                        updateLivesDisplay();
                        if (lives <= 0) {
                            gameOver();
                            return;
                        }
                    } else {
                        score += item.scoreVal;
                        particles.push(new Particle(player.x, player.y - 50, `+${item.scoreVal}`, "#f1c40f"));
                        document.getElementById('score-hud').textContent = `Score: ${score}`;
                    }
                    items.splice(i, 1);
                    continue;
                }

                // Remove off-screen
                if (item.y > canvas.height + 50) {
                    items.splice(i, 1);
                }
            }

            // Update Particles
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.update();
                p.draw();
                if(p.life <= 0) particles.splice(i, 1);
            }

            animationId = requestAnimationFrame(gameLoop);
        }

        // --- Buttons & Events ---
        document.getElementById('start-btn').addEventListener('click', startGame);
        document.getElementById('restart-btn').addEventListener('click', startGame);
        
        document.getElementById('copy-btn').addEventListener('click', function() {
            const code = document.getElementById('coupon-code').innerText;
            navigator.clipboard.writeText(code).then(() => {
                const originalText = this.innerText;
                this.innerText = "âœ… å·²è¤‡è£½ï¼";
                setTimeout(() => {
                    this.innerText = originalText;
                }, 2000);
            });
        });

    </script>
</body>
</html>
